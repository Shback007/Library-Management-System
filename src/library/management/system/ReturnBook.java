/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JFrame.java to edit this template
 */
package library.management.system;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.Date;
import javax.swing.JOptionPane;

/**
 *
 * @author SAGNI
 */
public class ReturnBook extends javax.swing.JFrame {
    Connection con = Connect.COnnection();
    private final Home home;
    /**
     * Creates new form ReturnBook
     * @param home
     */
    public ReturnBook(Home home) {
        this.home=home;
        initComponents();
        
        returnbname.setEditable(false);
        returnissue.setEditable(false);
        returnduedate.setEditable(false);
        returnsname.setEditable(false);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        retrunclose = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        jLabel7 = new javax.swing.JLabel();
        returnbname = new javax.swing.JTextField();
        returnsid = new javax.swing.JTextField();
        returnsname = new javax.swing.JTextField();
        returnissue = new javax.swing.JTextField();
        returnduedate = new javax.swing.JTextField();
        returnbook = new javax.swing.JButton();
        RetrunSearch = new javax.swing.JButton();
        returnBookIdCombo = new javax.swing.JComboBox<>();
        jLabel8 = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setUndecorated(true);
        getContentPane().setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        retrunclose.setIcon(new javax.swing.ImageIcon(getClass().getResource("/img/close icon.png"))); // NOI18N
        retrunclose.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                retruncloseActionPerformed(evt);
            }
        });
        getContentPane().add(retrunclose, new org.netbeans.lib.awtextra.AbsoluteConstraints(1090, 0, 50, -1));

        jLabel1.setFont(new java.awt.Font("Segoe UI", 1, 24)); // NOI18N
        jLabel1.setForeground(new java.awt.Color(255, 51, 204));
        jLabel1.setIcon(new javax.swing.ImageIcon(getClass().getResource("/img/isue.jpg"))); // NOI18N
        jLabel1.setText("Return Book");
        getContentPane().add(jLabel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(160, 50, 219, -1));

        jLabel2.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        jLabel2.setForeground(new java.awt.Color(102, 255, 102));
        jLabel2.setText("Student ID");
        getContentPane().add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(160, 180, 157, 31));

        jLabel3.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        jLabel3.setForeground(new java.awt.Color(102, 255, 102));
        jLabel3.setText("Book ID");
        getContentPane().add(jLabel3, new org.netbeans.lib.awtextra.AbsoluteConstraints(160, 260, 157, 31));

        jLabel4.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        jLabel4.setForeground(new java.awt.Color(102, 255, 102));
        jLabel4.setText("Book Name");
        getContentPane().add(jLabel4, new org.netbeans.lib.awtextra.AbsoluteConstraints(160, 340, 157, 31));

        jLabel5.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        jLabel5.setForeground(new java.awt.Color(102, 255, 102));
        jLabel5.setText("Student Name");
        getContentPane().add(jLabel5, new org.netbeans.lib.awtextra.AbsoluteConstraints(160, 420, 157, 31));

        jLabel6.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        jLabel6.setForeground(new java.awt.Color(102, 255, 102));
        jLabel6.setText("Issue Date");
        getContentPane().add(jLabel6, new org.netbeans.lib.awtextra.AbsoluteConstraints(160, 500, 157, 31));

        jLabel7.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        jLabel7.setForeground(new java.awt.Color(102, 255, 102));
        jLabel7.setText("Due Date");
        getContentPane().add(jLabel7, new org.netbeans.lib.awtextra.AbsoluteConstraints(160, 580, 157, 31));

        returnbname.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        returnbname.setCursor(new java.awt.Cursor(java.awt.Cursor.TEXT_CURSOR));
        getContentPane().add(returnbname, new org.netbeans.lib.awtextra.AbsoluteConstraints(410, 340, 211, -1));

        returnsid.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        returnsid.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                returnsidActionPerformed(evt);
            }
        });
        getContentPane().add(returnsid, new org.netbeans.lib.awtextra.AbsoluteConstraints(410, 180, 211, -1));

        returnsname.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        getContentPane().add(returnsname, new org.netbeans.lib.awtextra.AbsoluteConstraints(410, 420, 211, -1));

        returnissue.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        getContentPane().add(returnissue, new org.netbeans.lib.awtextra.AbsoluteConstraints(410, 500, 211, -1));

        returnduedate.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        getContentPane().add(returnduedate, new org.netbeans.lib.awtextra.AbsoluteConstraints(410, 580, 211, -1));

        returnbook.setBackground(new java.awt.Color(255, 255, 0));
        returnbook.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        returnbook.setText("Return Book");
        returnbook.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                returnbookActionPerformed(evt);
            }
        });
        getContentPane().add(returnbook, new org.netbeans.lib.awtextra.AbsoluteConstraints(250, 630, -1, 41));

        RetrunSearch.setBackground(new java.awt.Color(153, 0, 0));
        RetrunSearch.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        RetrunSearch.setForeground(new java.awt.Color(255, 255, 255));
        RetrunSearch.setText("Search");
        RetrunSearch.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                RetrunSearchActionPerformed(evt);
            }
        });
        getContentPane().add(RetrunSearch, new org.netbeans.lib.awtextra.AbsoluteConstraints(690, 180, -1, -1));

        returnBookIdCombo.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        returnBookIdCombo.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        returnBookIdCombo.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                returnBookIdComboActionPerformed(evt);
            }
        });
        getContentPane().add(returnBookIdCombo, new org.netbeans.lib.awtextra.AbsoluteConstraints(410, 260, 211, -1));

        jLabel8.setIcon(new javax.swing.ImageIcon(getClass().getResource("/img/stureg.png"))); // NOI18N
        getContentPane().add(jLabel8, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 0, 1140, 780));

        pack();
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    private void returnsidActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_returnsidActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_returnsidActionPerformed

    private void retruncloseActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_retruncloseActionPerformed
        // TODO add your handling code here:
        home.setEnabled(true);
        this.dispose();
    }//GEN-LAST:event_retruncloseActionPerformed

    private void RetrunSearchActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_RetrunSearchActionPerformed
        // TODO add your handling code here:
        if(returnsid.getText().equals("")){
            JOptionPane.showMessageDialog(this, "Please Enter Student Id and Search it");
            returnsid.requestFocus();
        }
        else {
        try {
            returnBookIdCombo.removeAllItems();
            PreparedStatement pst = con.prepareStatement(
                    "SELECT books.bid,student.name " +
                    "FROM books " +
                    "INNER JOIN student ON books.student_id=student.id " +
                    "WHERE student.id = ? AND books.status = 'ISSUED'" 
            );
            pst.setString(1, returnsid.getText());
            ResultSet rs = pst.executeQuery();
            
            boolean found= false;
            String studentName="";
            
            while(rs.next()){
                String bid = rs.getString("bid");
                studentName = rs.getString("name");
                returnBookIdCombo.addItem(bid);
                found=true;
            }if(found)
                returnsname.setText(studentName);
            else 
                JOptionPane.showMessageDialog(this, "No issued books found for the Student Id");

        } catch (SQLException ex) {
                System.getLogger(ReturnBook.class.getName()).log(System.Logger.Level.ERROR, (String) null, ex);
                JOptionPane.showMessageDialog(this, "Database error:" + ex.getMessage());
            }
        }
    }//GEN-LAST:event_RetrunSearchActionPerformed

    private void returnBookIdComboActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_returnBookIdComboActionPerformed
        // TODO add your handling code here:
          String selectedBid = (String) returnBookIdCombo.getSelectedItem();
    if (selectedBid != null) {
        try {
            PreparedStatement pst = con.prepareStatement(
                "SELECT name, issue_date, due_date FROM books WHERE bid = ?"
            );
            pst.setString(1, selectedBid);
            ResultSet rs = pst.executeQuery();
                  
            if (rs.next()) {
                returnbname.setText(rs.getString("name"));
                returnissue.setText(rs.getString("issue_date"));
                returnduedate.setText(rs.getString("due_date"));
            } 
        } 
        catch (SQLException ex) {
                  System.getLogger(ReturnBook.class.getName()).log(System.Logger.Level.ERROR, (String) null, ex);
        }

        
    }
    }//GEN-LAST:event_returnBookIdComboActionPerformed

    private void returnbookActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_returnbookActionPerformed
        // TODO add your handling code here:
        String selectedBid = (String) returnBookIdCombo.getSelectedItem();
        if(selectedBid == null || selectedBid.isEmpty()){
            JOptionPane.showMessageDialog(this, "Please select a Book ID to return");
            return;
        }
        try {
            PreparedStatement pst = con.prepareStatement(
                    "UPDATE books SET status = 'NOT-ISSUED', issue_date=NULL, due_date=Null, student_id=NULL WHERE bid= ?");
            pst.setString(1, selectedBid);
            int updateRows=pst.executeUpdate();
            if(updateRows >0 ){
                JOptionPane.showMessageDialog(this, "Book returned successfully");
                 returnBookIdCombo.removeAllItems();
            returnbname.setText("");
            returnissue.setText("");
            returnduedate.setText("");
            returnsname.setText("");
            returnsid.setText("");
            }
            else{
                JOptionPane.showMessageDialog(this, "No matching book found or update failed");
            }
        } catch (SQLException ex) {
            System.getLogger(ReturnBook.class.getName()).log(System.Logger.Level.ERROR, (String) null, ex);
            JOptionPane.showMessageDialog(this, "Error returning book: " + ex.getMessage());
        }
    }//GEN-LAST:event_returnbookActionPerformed

    /**
     * @param args the command line arguments
     */
  
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton RetrunSearch;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JButton retrunclose;
    private javax.swing.JComboBox<String> returnBookIdCombo;
    private javax.swing.JTextField returnbname;
    private javax.swing.JButton returnbook;
    private javax.swing.JTextField returnduedate;
    private javax.swing.JTextField returnissue;
    private javax.swing.JTextField returnsid;
    private javax.swing.JTextField returnsname;
    // End of variables declaration//GEN-END:variables
}
